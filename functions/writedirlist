# -*- sh -*-

# <Function Class: cd>

writedirlist ()
{
    echo "${FUNCNAME[0]} \"$@\" ## $(date +%Y%m%d%H%M%S)" >> ${TILDAE:-$HOME}/personal/data/funcsaudit ## This is audit
    # Write the list of dirs to the disk. You can have different lists if you
    # use the context arg.
    local edit=0
    local context=$DIRLIST_CONTEXT
    local dirlistfile=$DIRLIST_FILE
    local lockfile=$DIRLIST_LOCK
    if [ "$1" = '--edit' ]
    then
        edit=1
        shift
    fi
    if [ -z "$1" ]
    then
        context=$DIRLIST_CONTEXT
    else
        DIRLIST_CONTEXT=$1
        context=$1
    fi
    if [ -n "$context" ]
    then
        dirlistfile="${dirlistfile}.${context}"
        lockfile="${lockfile}.${context}"
    fi
    cleandirlist
    (
        ## lock, exclusive, 60 second timeout, file descriptor 200 (0 is stdin,
        ## 1 is stout, 2 is stderr)
        flock -e -w 60 200
        if [ "$edit" = 0 ]
        then
            echo $DIRLIST > $dirlistfile
        else
            echo > $dirlistfile
            for i in $DIRLIST
            do
                echo $i >> $dirlistfile
            done
            $EDITOR vi $DIRLIST_FILE
        fi
    ) 200>$DIRLIST_LOCK
    readdirlist
}


