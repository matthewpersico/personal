# -*- sh -*-

# vmfuncs

VMFUNCS_FILE=${BASH_SOURCE[0]}

vmfuncs-edit ()
{
    xo $VMFUNCS_FILE
}

vmfuncs-reload ()
{
    . $VMFUNCS_FILE
}
alias vmfuncs-load=vmfuncs-reload

vmfuncs-help () {
    help_strings $VMFUNCS_FILE "$@"
}

VMFUNCS_TOOLKIT_FILE=~/.ssh/id_rsa.toolkit
VMFUNCS_TOOLKIT_EXPIRE_FILE=~/.ssh/id_rsa.toolkit.expires
VMFUNCS_BCPCVMS_FILE=~/personal/bin/.bcpcvms

vmchoose ()
{
    ##@@ none||none||vmchoose||pick a VM to connect to
    local PS3='Pick a machine:'
    select vmname in ${!vmips[@]}
    do
        if [ -n "$vmname" ]
        then
            break
        fi
    done
    echo $vmname
}

vmgo ()
{
    ##@@ none||none||vmgo||connect to VM
    vm_toolkit_file_maint

    . $VMFUNCS_BCPCVMS_FILE
    vmname=${1:-undef}

    if [ "${vmips[$vmname]}" = '' ]
    then
        vmname=$(vmchoose)
    fi
    vmip=${vmips[$vmname]}
    ssh -i $VMFUNCS_TOOLKIT_FILE $vmip $@
}
alias govm='vmgo '

vmshow ()
{
    ##@@ none||none||vmshow||show the list of VMs
    cat $VMFUNCS_BCPCVMS_FILE | grep -v 'declare -A vmips'
}
alias showvm='vmshow '

vmadd ()
{
    ##@@ none||none||vmadd||add a VM to the list
    if [ $# != '2' ]
    then
        echo usage vmadd name ip
        return 1
    fi

    echo "vmips[$1]=$2" >> $VMFUNCS_BCPCVMS_FILE
    sort -u $VMFUNCS_BCPCVMS_FILE | grep -v 'declare -A vmips' > $VMFUNCS_BCPCVMS_FILE.$$

    echo 'declare -A vmips' >  $VMFUNCS_BCPCVMS_FILE
    cat $VMFUNCS_BCPCVMS_FILE.$$ >> $VMFUNCS_BCPCVMS_FILE
    rm -f $VMFUNCS_BCPCVMS_FILE.$$
    vmshow
}
alias addvm='vmadd '

vmdel ()
{
    ##@@ none||none||vmdel||remove a VM from the list
    . $VMFUNCS_BCPCVMS_FILE
    vmname=${1:-undef}

    if [ "${vmips[$vmname]}" = '' ]
    then
        vmname=$(vmchoose)
    fi
    cat $VMFUNCS_BCPCVMS_FILE | grep -v "vmips\[$vmname\]=${vmips[$vmname]}" > $VMFUNCS_BCPCVMS_FILE.$$
    mv $VMFUNCS_BCPCVMS_FILE.$$ $VMFUNCS_BCPCVMS_FILE
    vmshow
}
alias delvm='vmdel '

NFSMACHINE=nylxdev1.dev.bloomberg.com
cptonfs ()
{
    ##@@ none||none||cptonfs||copy a file to the vmbounce directory of the NFS filesystem
    scp "$@" $NFSMACHINE:vmbounce
}
alias cp-to-nfs='cptonfs '
alias scp-to-nfs='cptonfs '

cpfromnfs ()
{
    ##@@ none||none||cpfromfs||copy a file from the vmbounce directory of the NFS filesystem to the local ~/vmbounce directory
    mkdir -p ~/vmbounce
    scp $NFSMACHINE:vmbounce/* ~/vmbounce
}
alias cp-from-nfs='cpfromnfs '
alias scp-from-nfs='cpfromnfs '

bldo-check ()
{
    ##@@ none||none||bldo-check||ssh all the BDLO machines to refresh the RSA keys
    local bldos=$(cat /bb/csdata/bldfarm/pools/*BLDO* 2>/dev/null)
    if [ -z "$bldos" ]
    then
        echo No BLDO files found
    else
        local hcount=$(echo $bldos | wc -w)
        local hindex=0
        for h in $bldos
        do
            ((hindex+=1))
            echo "*** $h ($hindex/$hcount) ***"
            ssh $h "echo 'Connected!'"
        done
    fi
}
