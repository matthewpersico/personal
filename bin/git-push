#!/usr/bin/env bash

echo "$(date): git-push" >> "$HOME/.gitaudit"

# git-push

# shellcheck disable=SC1090
source "$BASH_INC_DIR/on_exit.binc"

if ! git-version-verify 'git-push'
then
    exit 1
fi

# shellcheck disable=SC2034 # We'll use it eventually
cmd_echo_id='git-push'

usage ()
{
    (
        [ -n "$*" ] && cmd-echo -- "$@"
        echo "** Extended actions **"
        bash-usage "$0"
        echo
        echo "** Standard actions **"
        "$REALGIT" push --help
    ) 2>&1 | ${PAGER:-less}
}

declare dispatch_to_real_git=1
declare opt_popup=0
declare opt_pr=0

declare -a pass_on

## DO NOT attempt to convert this to a 'getopt' implementation; it would
## require specifying and handling every existing option in 'git push',
## and it is just not necessary.
while (( $# ))
do
    declare arg=$1
    shift
    case "$arg" in
        ##
        ## Our options
        ##
        --popup )
            opt_popup=1
            ;;
        --pr )
            opt_pr=1
            ;;
        --help | -h )
            usage ''
            exit 0
            ;;
        * )
            pass_on+=("$arg")
            ;;
    esac
done

if ((dispatch_to_real_git))
then
    ## Currently, we ALWAYS run the real git push first.
    "$REALGIT" push "${pass_on[@]}" || exit $?
fi

## Then we tack on our actions if requested.
if ((opt_popup || opt_pr))
then

    # Get info for our fork.
    declare remote
    remote=$(git-get-default-remote)
    declare svc
    svc=${remote%:*}
    declare orgrepo
    orgrepo=${remote#*:}
    declare org
    org=${orgrepo%/*}

    # Get info for the upstream.
    declare upstream_svcorgrepo
    upstream_svcorgrepo=$(git remote get-url --push upstream)
    declare upstream_orgrepo
    upstream_orgrepo=${upstream_svcorgrepo#*:}

    # Make sure we realize we are not clean, in case that's unexpected.
    declare statusdata
    statusdata=$(mktemp -t tmp.git-web.statusdata.$$.XXXXXXXXXX)
    rm-on-exit "$statusdata"
    git status --porcelain -b -uno > "$statusdata"
    declare linecount
    linecount=$(wc -l < "$statusdata")
    declare outofdate
    outofdate=$(grep '##' "$statusdata" | grep '\[')
    if ((linecount > 1)) || [ -n "$outofdate" ]
    then
        cmd-echo -wc -- "Current status not clean:"
        git status
    fi

    declare url
    declare url_svc

    url_svc="$(git kv --get "browser-urls.$svc")"

    if ((opt_pr))
    then
        if ! url=$(git repo pr --get)
        then
            cmd-echo -- "No existing PR found, popping up create URL..."
set -x
            declare current_branch
            current_branch="$(git branch --show-current)"

            declare default_branch
            default_branch=$(git repo default-branch)

            if [ "$current_branch" = "$default_branch" ]
            then
                cmd-echo -wc -- "Not generating a PR. Using the default branch '${default_branch}' branch on a clone won't work; you've already pushed to ${default_branch}."
                exit 1
            fi

            ## This url does not let us PR against an arbitrary branch. If this
            ## branch is not based on the default  branch, you have to remember
            ## that and set the PR accordingly at the GUI after we pop it up.
            url="$url_svc/$orgrepo/pull/new/$current_branch"

            ## This url does let us PR against an arbitrary branch. For now use
            ## the default branch.
            declare from_branch
            from_branch=$(git config --get "worktree.${current_branch}.extmeta-from-branch")

            ## Only for a worktree created before we started writing the
            ## from-branch. We always write it even if it is the default.
            [[ -z $from_branch ]] && from_branch=$(git repo default-branch)

            url="$url_svc/$upstream_orgrepo/compare/$from_branch...$org:$current_branch"
            cmd-echo --dc -- \
                     "Here is the url for the pull that allows the pull to be against non-default branches:" \
                     "$url"
        else
            cmd-echo -- "Existing PR found, popping it up..."
        fi
    else
        url="$url_svc/$orgrepo"
    fi

    git web--browse "$url" &
fi

exit 0

## You can add sections with =head1, but stick to =item for section breakdowns,
## not =head2/3/etc/. If you want just plain text, get rid of pod tags and the
## 'POD' in __PODUSAGE__.

:<<'__PODUSAGE__'
=head1 NAME

git-push - extension to git push

=head1 SYNOPSIS

 git-push [STANDARD OPTS] --popup|--pr ...

=head1 DESCRIPTION

Calls the real 'git push' and then processes our options, if specified.

=head1 OPTIONS

=over 4

=item popup

Start a browser (via git web--browser) pointing to the URL of the origin for the current repo.

=item pr

Start a browser (via git web--browser) pointing to the URL to create a new pull request using the current repo as the source if there is no existing PR. If there is an existing PR, its URL is used.

=back

__PODUSAGE__
