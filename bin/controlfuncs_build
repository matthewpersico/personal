#!/usr/bin/env bash

# controlfuncs_build

source $BASH_INC_DIR/on_exit.binc

# Build control functions for *funcs files
if [ -n "$1" ]
then
    spec=$1
    file=$(basename $1)
    shift
else
    spec=${BASH_SOURCE[1]}
    file=$(basename ${BASH_SOURCE[1]})
fi

alias=${spec}.alias
if (($#))
then
    extra_edit="$@"
    extra_load="local f; for f in $@; do . $f; done"
else
    extra_edit=''
    extra_load=''
fi
tmp=$(mktemp --suffix=.controlfuncs_build)
rm_on_exit $tmp

cat <<EOF >$tmp
${file}-edit ()
{
    ${file}_audit "\$@"
    local editor; editor=\$(editor_opt xo "\$@"); shift \$?
    [ ! -f $alias ] && alias=''
    \$editor $spec $alias $extra_edit
}

${file}-reload ()
{
    ${file}_audit "\$@"
    . $spec
    [ -f $alias ] && . $alias
    $extra_load
}

${file}-load ()
{
    ${file}-audit "\$@"
    ${file}-reload "\$@"
}

${file}-help () {
    help_strings $spec "\$@"
}

safe_func_export ${file}-edit ${file}-reload ${file}-load ${file}-help
EOF
. $tmp

\rm $tmp
