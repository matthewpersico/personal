#!/usr/bin/env bash

# bash_history_reindex

declare BHRI_STACK
get-stack BHRI_STACK
echo "$(date) $BHRI_STACK" >> "${TILDAE}/bash_history.audit"

declare work_index_file="$HISTDIR/.histindex.reindex.$$"

declare -a hist_files
hist_files=("$HISTDIR"/hist.*)

bash_history_index --outfile "$work_index_file" "${hist_files[@]}"

declare index_file="$HISTDIR/.histindex"
bash-file-lock "$index_file" || exit $?
\mv -f "$work_index_file" "$index_file"
bash-file-lock --unlock "$index_file" || exit $?

true; exit $?
