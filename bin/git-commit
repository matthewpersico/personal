#!/usr/bin/env bash

# git-commit

# shellcheck disable=SC1090
source "$BASH_INC_DIR/on_exit.binc"

cmd_echo_id='git-commit'

## Before we even start, make sure that the underlying client hasn't changed
## under us. Otherwise we can have issues with the passthough options, either
## new ones we don't handle or deprecated ones we have not removed.

realgit_verified_version_string='git version 2.19.2'
if [ ! "$($REALGIT --version)" = "$realgit_verified_version_string" ]
then
    cmd-echo -id "$cmd_echo_id" -e -- \
             "Verified to $realgit_verified_version_string," \
             "but $($REALGIT --version) is installed." \
             "Please investigate."
    exit 1
fi

usage ()
{
    (
        [ -n "$*" ] && cmd-echo -- "$@"
        echo "** Extended actions **"
        script-usage
        echo
        echo "** Standard actions **"
        "$REALGIT" commit --help
    ) 2>&1 | ${PAGER:-less}
}

## Functions that encapsulate the enhanced functionality. main() is defined
## last and called last.
git-commit-wscl()
{
    git-commit-with-source-ctrl-log-guts "$@"
    return $?
}

main ()
{
    declare opt_wscl=0
    declare moreopts=1
    declare -a pass_on_args

    ## This hunk of processing was written after git-clone and is an attempt to
    ## NOT have to duplicate all existing arg process, as is done in git-clone,
    ## because we only need to pick out one option.
    while [ -n "$1" ] && ((moreopts))
    do
        declare original="$1"

        if [[ "$original" =~ ^- ]]
        then
            if [[ "$original" =~ -h ]]
            then
                usage ''
                exit 0
            fi

            if [[ "$original" =~ -wc ]]
            then
                cmd-echo -- "-wc is deprecated. Use -wscl"
                original='-wscl'
            fi
            if [[ "$original" =~ -wscl ]]
            then
                ## This is what we need to pull out of the args before passing on
                shift
                opt_wscl=1
                ## no pass_on_args here
                continue
            fi

            if [[ "$original" =~ -ammend ]]
            then
                cmd-echo "Can you please learn how to spell 'amend'?"
                original='--amend'
            fi
        fi

        ## If we are here, pass it on
        shift
        pass_on_args+=("$original")
    done

    if ((opt_wscl))
    then
        git-commit-wscl "${pass_on_args[@]}"
    else
        ## Dispatch to real git commit
        "${REALGIT}" commit "${pass_on_args[@]}"
    fi

    return $?
}

main "$@"
exit $?

:<<'__PODUSAGE__'
=head1 NAME

git-commit - git extention of git commit

=head1 SYNOPSIS

 git commit -wscl

=head1 DESCRIPTION

Extensions to the 'git commit' command. Any action not described here will be passed onto the actual 'git branch' command.

=head1 EXTENSIONS

=over 4

=item --wscl

Use the local $GITFUNCS_SOURCE_CTRL_LOG_NAME file for commit messages.

=back

=cut

__PODUSAGE__
