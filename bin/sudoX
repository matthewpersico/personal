#!/usr/bin/env bash

# sudoX

# How to allow a sudo'ed session to talk back on your unsudo'ed X DISPLAY, with
# added instructions to use the ptkdb Perl debugger at Bloomberg.

# shellcheck disable=SC2155 #https://github.com/koalaman/shellcheck/wiki/SC2155
declare hn=$(hostname)
declare hds="${DISPLAY//localhost/$hn}"
# shellcheck disable=SC2001 #https://github.com/koalaman/shellcheck/wiki/SC2001
declare hd=$(echo "$hds" | sed 's/\(:[0-9][0-9]*\)\..*/\1/g')
COOKIE=$(xauth list | sed 's/\/unix//' | grep "$hd " | awk '{print $NF}')
if [[ -z "$COOKIE" ]]; then
    echo "Can't find cookie!"
    exit 1
fi
echo "## after sudo -u blah -i, do the following:"
echo "DISPLAY=$DISPLAY;export DISPLAY"
echo "COOKIE=$COOKIE;export COOKIE"
echo "xauth add \$DISPLAY . \$COOKIE"
echo 'For Perl at Bloomberg:'
echo "/opt/bb/bin/perl -i /home/$SUDO_USER/perl/5.16/lib/perl5/ -d:ptkdb"
echo '## done'
exit 0
