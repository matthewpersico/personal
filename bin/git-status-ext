#!/usr/bin/env bash

# git-status-ext

cmd_echo_id='git-status'

## Before we even start, make sure that the underlying client hasn't changed
## under us. Otherwise we can have issues with the passthough options, either
## new ones we don't handle or deprecated ones we have not removed.

realgit_verified_version_string='git version 2.19.2'
if [ ! "$($REALGIT --version)" = "$realgit_verified_version_string" ]
then
    cmd-echo -id "$cmd_echo_id" -e -- \
             "Verified to $realgit_verified_version_string," \
             "but $($REALGIT --version) is installed." \
             "Please investigate."
    exit 1
fi

usage ()
{
    (
        echo "** Extended actions **"
        script-usage git-status-ext
        script-usage git-status-with-source-ctrl-log
        echo
        echo "** Standard actions **"
        "${REALGIT}" status --help
    ) 2>&1 | ${PAGER:-less}
}

[[ "$1" =~ -h ]] && usage && exit 0

declare color
if [ ! "$(git root)" = "$(pwd)" ]
then
    cmd-echo "Must run git status-ext from the root" \
             "    $(git root)" \
             "not the current directory" \
             "    $(pwd)"
    exit 1
fi

color='--color=never'
{ [ -t 1 ] || [ -p /dev/stdout ] ; } && color="--color=always"

echo
echo "=== Latest log entry:"
git log $color -1
echo
echo "=== Status:"
git branch info local-status
declare gmdw
gmdw=$(git branch info delete-worktree)
# shellcheck disable=SC2086 # Don't want quotes around the date with @
[ -n "$gmdw" ] && \
    echo "Worktree scheduled for removal on or after $( date --date=@$gmdw)"
git branch info pull-request
declare outcmd=cat
if [[ "$1" =~ -dif ]]
then
    outcmd='less -RE'
fi
git-status-with-source-ctrl-log $color "$@" | grep -v "No files specified" | $outcmd

## You can add sections with =head1, but stick to =item for section breakdowns,
## not =head2/3/etc/. If you want just plain text, get rid of pod tags and the
## 'POD' in __PODUSAGE__.

:<<'__PODUSAGE__'
=head1 NAME

git-status-ext - extended git status

=head1 SYNOPSIS

 git status-ext [--diff] [pathspec...]

=head1 DESCRIPTION

A git status command enhanced as follows:

=over 4

=item Latest log entry

The log entry for the latest commit in the repo (git log -1) is shown.

=item Local information

If the branch was annotated with a git branch info call when created, this note
is displayed.

=item Deletion information

If the branch is scheduled to be deleted, that time is shown.

=item Status with source-ctrl-log entries.

If SourceCtrlLog is found in the repo or worktree root, its contents are mixed
in with the regular git status display. If --diff is specfied, the git diff
output is also mixed in.

=back

=cut

__PODUSAGE__
