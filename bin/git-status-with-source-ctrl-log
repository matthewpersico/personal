#!/usr/bin/env bash

# git-status-with-source-ctrl-log

declare diff
declare cached
declare nosclonly
declare color
declare -a color_opt

# Define the options. ':' suffix for a mandatory value to an option, '::' for
# an optional one. Note that the long and short don't have to match up.
declare OPTSARGS
declare shortopts='xh'
declare longopts='filesonly,nosclonly,diff,cached,help,debug,color:,nocolor'

# Process the command line.
OPTSARGS=$(getopt -a -o "$shortopts" -l "$longopts" -n "$(basename "$0")" -- "$@")
declare status=$?
((status != 0)) && exit $status ## return $status ## in functions

# Reset the command line ($@).
eval set -- "$OPTSARGS"

# Reprocess the command line, extracting options and their arguments into
# variables.
while true
do
    declare option=$1
    shift
    case "$option" in
        --filesonly) filesonly='--filesonly';;
        --nosclonly) nosclonly='--nosclonly';;
        --diff) diff='--diff';;
        --cached) cached='--cached';;
        -h|--help) bash-usage "$0"; exit 0 ;;
        --debug | -x ) set -x; trap 'set +x' EXIT;;
        --color) color=$1
                 shift
                 color_opt=(--color "$color")
                 ;;
        --nocolor)
            color_opt=(--color "never")
            ;;
        --) break ;; ## VITAL!!! Exits the while loop, no more options,
                     ## remaining $*, if any, are args
        *)
            cmd-echo -ec -- "$option is an invalid option. See $0 --help"
            exit 1 ## return 1 in functions
            ;;
    esac
done

## Locate all the files to process
declare -a filenames
if (($#))
then
    ## Process what's specified
    filenames=("$@")
else
    mapfile -t filenames < <(git what is edited)
fi

git-process-source-ctrl-log --withstatus $diff $cached "${color_opt[@]}" $nosclonly $filesonly "${filenames[@]}"

exit 0

:<<'__PODUSAGE__'
=head1 NAME

git-status-with-source-ctrl-log - merge a SourceCrtlLog file with git status

=head1 SYNOPSIS

    git-status-with-source-ctrl-log [--nosclonly] [--diff [--cached]] [--color [always|never] | --nocolor]
    git-status-with-source-ctrl-log [--help] [--diff] [--cached] [--color [always|never]]

=head1 DESCRIPTION

Run a 'git status' and interleave the entries from SourceCrtlLog in.

=head1 OPTIONS

=over 4

=item nosclonly

Only print status for items that have no entry in SourceCrtlLog.

=item diff

Also mix in the git diff of the item.

=item cached

Do the git diff with the --cached flag.

=item color

Specify if coloring the output or not.

=item nocolor

Alias for --color never

=back

=cut
__PODUSAGE__
