#!/usr/bin/env bash

# git-set-triangle

[ -z "$4" ] && func_usage && exit 1

declare githosturl
githosturl=$1
declare githostkeycheck
githostkeycheck=$(kvstore keys gitfuncs_gitsvcs | grep -E "^$githosturl$")
if [ -n "$githostkeycheck" ] ; then
    echo "Supposed to provide a URL, not a service name. Converting..."
    githosturl=$(kvstore get gitfuncs_gitsvcs "$githostkeycheck")
    if [ -z "$githosturl" ]
    then
        echo "No url found for githost '$1'";
        exit 1
    fi
fi

declare upstream_namespace
upstream_namespace=$2
declare origin_namespace
origin_namespace=$3
declare repo
repo=$4

declare -A triangle_workflow
triangle_workflow[branch.master.merge]="refs/heads/master"
triangle_workflow[branch.master.mergeoptions]="--ff-only"
triangle_workflow[branch.master.remote]="upstream"

triangle_workflow[remote.origin.url]="${githosturl}${origin_namespace}/${repo}"
triangle_workflow[remote.pushdefault]="origin"
triangle_workflow[remote.upstream.url]="${githosturl}${upstream_namespace}/${repo}"

declare key
for key in "${!triangle_workflow[@]}"
do
    git config --replace-all "$key" "${triangle_workflow[$key]}" || exit $?
done

##
## These are special because they repeat
##
key='remote.origin.fetch'

git config --replace-all $key "+refs/heads/*:refs/remotes/origin/*" || exit $?
git config --add         $key "+refs/pull/*/head:refs/pull/origin/*" || exit $?
## ^ allows git checkout -b 3 pull/origin/3

key='remote.upstream.fetch'
git config --replace-all $key "+refs/heads/*:refs/remotes/upstream/*" || exit $?
git config --add         $key "+refs/pull/*/head:refs/pull/upstream/*" || exit $?
git config --add         $key "+refs/notes/*:refs/notes/*" || exit $?
## ^ allows git checkout -b 3 pull/upstream/3

## Our own metadata
git config --replace-all git-set-triangle.created "$(date +%Y-%m-%d %H:%M:%S %z)" || exit $?
git config --replace-all git-set-triangle.remote "${origin_namespace}" || exit $?

exit 0

## You can add sections with =head1, but stick to =item for section breakdowns,
## not =head2/3/etc/.

:<<'__PODUSAGE__'
=head1 NAME

git-set-triangle - script that does something

=head1 SYNOPSIS

 git-set-triangle [--option1] [ --option2 optionarg ] arg1 [arg2 ...]
     [fee] [dfsdfs] [sfsdfsf]

=head1 DESCRIPTION

Describe in general terms what git-set-triangle does.

=head1 ARGUMENTS

=over 4

=item arg

Describe what arg does, should be, etc. Add a new =item for each distinct arg.

=back

=head1 OPTIONS

=over 4

=item --option1

Describe what --option1 does.

=item --option2

Describe what --option2 does. Describe what optionarg does.

=over 2

=item *

A choice for optionarg

=item *

Another choice for optionarg

=back

=back

=cut

__PODUSAGE__
