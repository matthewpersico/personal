#!/usr/bin/env bash

# <Function Class: dotfiles>
# <Function Justification: none>

makesymlinks ()
{
    # creates symlinks from any target file to the git-controlled source in
    # ~/personal/dotfiles. Use this when initing a new vm.

    local opwd
    opwd=$(pwd)

    # create DOTFILES_OLDDIR
    if [ ! -d "$DOTFILES_OLDDIR" ]
    then
        echo -n "Creating $DOTFILES_OLDDIR for backup of any existing dotfiles in ~..."
        mkdir -p "$DOTFILES_OLDDIR"
        echo "done"
    fi

    # shellcheck disable=SC1090
    . "$DOTFILES_MANIFEST"

    # change to the dotfiles directory
    echo -n "Changing to the $DOTFILES_DIR directory ..."
    builtin cd "$DOTFILES_DIR" || exit 1
    echo "done"

    # Move any existing dotfiles in to dotfiles_old directory, then create
    # symlinks from the original location to the corresponding files in the
    # ~/dotfiles directory.
    # shellcheck disable=SC2154 #dotfiles assigned in DOTFILES_MANIFEST source above
    for src in "${!dotfiles[@]}"
    do
        local fullsrc=$DOTFILES_DIR/$src
        local fulllink=${dotfiles[$src]}
        makesymlink --backup "$DOTFILES_OLDDIR" --verbose --relative "$fullsrc" "$fulllink"
    done
    builtin cd "$opwd" || exit 1
}
