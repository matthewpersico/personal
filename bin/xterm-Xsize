#!/usr/bin/env bash

# xterm-Xsize

script-echo -i

[ -z "$1" ] && echo "Missing arg: row or col" && exit 1
if is-xterm
then
    declare current
    current=$(stty -a |
                  grep row |
                  perl -MData::Dumper -n -a -F\; \
                       -e 'for (@F) {
                             $_=~s/^\s+//;
                             @d = split (/\s+/, $_);
                             if ($d[0] =~ m/row|col/) {
                               $k = shift @d;
                               $F{$k} = join(q( ), @d);
                             }
                           }
                           END { print join(q(;),@F{qw(rows columns)} )}'
          )
    if [ -z "$1" ]
    then
        echo "$current"
        exit "$OK"
    else
        declare rows=${current%%;*}
        declare cols=${current#*;}
        declare redraw=0
        if [[ "$1" =~ row ]]
        then
            echo "$rows"
            if [ -n "$2" ]
            then
                rows=$2
                redraw=1
            fi
        else
            echo "$cols"
            if [ -n "$2" ]
            then
                cols=$2
                redraw=1
            fi
        fi
        if ((redraw))
        then
            # from https://stackoverflow.com/questions/4709581/xterm-terminal-and-resize-code
            #          CSI
            echo -en "\\x1B[8;${rows};${cols};t" > /dev/tty
        fi
    fi
else
    script-echo "TERM does not match known pattern, probably not xterm-compatible" >&2
fi
