# -*- sh -*-

# histfuncs

HISTFUNCS_FILE=${BASH_SOURCE[0]}

histfuncs_edit ()
{
    xo $HISTFUNCS_FILE
}
alias histfuncs-edit=histfuncs_edit

histfuncs_reload ()
{
    . $HISTFUNCS_FILE
}
alias histfuncs-reload=histfuncs_reload

histinit ()
{
    if [ -z "$histinited" ] ||  [ "$1" = '--force' ]
    then
        histinited=1
        HISTSIZE=9000
        HISTFILESIZE=$HISTSIZE
        HISTTIMEFORMAT="%m/%d - %H:%M:%S "
        HISTFILE=~/.bash_histories/$(hostname).$(date +%Y_%m_%d_%H_%M_%S).$$
        if [ ! -d ~/.bash_histories ]
        then
            echo "Initializing bash command history setup..."
            mkdir -p ~/.bash_histories
        fi
        if [ "$1" = '--force' ]
        then
           echo "History inited."
        fi
    fi
}
histinit

_bash_history_sync ()
{
  builtin history -a         #1
  HISTFILESIZE=$HISTSIZE     #2
  builtin history -c         #3
  builtin history -r         #4
}

PROMPT_COMMAND=_bash_history_sync

history ()
{
  _bash_history_sync
  builtin history "$@"
}

stash_history ()
{
    cp -v $HISTFILE $(dirname $HISTFILE)/$1
}
alias stash_hist='stash_history '
alias stash-hist='stash_history '
alias hist-stash='stash_history '
alias hist_stash='stash_history '

show_history ()
{
    local hf=$(basename $HISTFILE)
    ls -lrt $(dirname $HISTFILE) | sed "s|$hf|$hf <= current|"
}

alias show_hist='show_history '
alias show-hist='show_history '
alias show_hist='show_history '
alias showhist='show_history '
alias hist-show='show_history '
alias hist_show='show_history '
alias histshow='show_history '
alias list_hist='show_history '
alias list-hist='show_history '
alias listhist='show_history '
alias hist-list='show_history '
alias hist_list='show_history '
alias histlist='show_history '

grep_history ()
{
    set -x
    local hostfilt=''
    if [ "$1" = '-h' ]
    then
        hostfilt=$2
        shift;shift;
    fi
    grep "$1" $(ls -rt $(dirname $HISTFILE)/$hostfilt*)
    set +x
}
alias grep_hist='grep_history '
alias grep-hist='grep_history '
alias grephist='grep_history '
alias hist-grep='grep_history '
alias hist_grep='grep_history '
alias histgrep='grep_history '

cat_history ()
{
    local cathist=$1
    if [ -z "$1" ]
    then
        select cathist in $(ls -rt $(dirname $HISTFILE)/*)
        do
            if [ -n "$cathist" ]
            then
                break
            fi
        done
    fi
    if [ -n "$cathist" ]
    then
        cathist=$(dirname $HISTFILE)/$(basename $cathist)
        cat $cathist
    fi
}

alias cat_hist='cat_history '
alias cat-hist='cat_history '
alias cathist='cat_history '
alias hist-cat='cat_history '
alias hist_cat='cat_history '
alias histcat='cat_history '

rename_history ()
{
    if [ -z "$1" ]
    then
        echo usage: rename_history suffix
    else
        cp $HISTFILE "${HISTFILE}.$1"
        HISTFILE="${HISTFILE}.$1"
    fi
    echo "Done"
}

alias rename_hist='rename_history '
alias rename-hist='rename_history '
alias renamehist='rename_history '
alias hist-rename='rename_history '
alias hist_rename='rename_history '
alias histrename='rename_history '

## Legacy defs
alias hist='history '
alias histg='history | grep '
alias histgf='grep_history -h $(hostname)'
alias histgfa='grep_history '
