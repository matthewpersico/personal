#!/usr/bin/env bash

# newx

declare var
declare more_opts
more_opts=1
declare count
count=1
declare lxtermgeo_w
lxtermgeo_w="$XTERMGEO_W"
declare -a schemes
declare proc_handling=''
while ((more_opts)) && [[ "$1" =~ ^- ]]
do
    declare original="$1"
    declare option
    option=$(dashstripper "$1")

    case $option in
        h* )
            bash-usage "$0"
            exit 0 ;;
        procbg )
            proc_handling='bg' ; shift ;;
        procda )
            proc_handling='da' ; shift ;;
        w )
            ## wide
            ((lxtermgeo_w*=2)) ; shift ;;
        n )
            ## narrow
            ((lxtermgeo_w/=2)) ; shift ;;
        s )
            ## std
            ((lxtermgeo_w+-0)) ; shift ;;
        [0-9]* )
            ## number of xterms to spawn
            ((count=$1*-1)) ; shift ;;
        scheme )
            tmpfile=/tmp/newx.$$
            echo 'The list of avaliable color schemes is (scheme=foreground,background)'
            env | grep FOREBACKMAP | perl -pe 's/FOREBACKMAP_(.*)=(.*)/\1=\2/;$_=lc()' | sort > $tmpfile
    	    cat $tmpfile
            example_scheme=$(head -$((RANDOM % $(wc -l < $tmpfile) )) $tmpfile | tail -1 | sed 's/=.*//')
            echo "Re-run using -oneofthoseschemes, i.e.; -$example_scheme"
            \rm -f $tmpfile
	        exit 0 ;;
        * )
            echo "Invalid option: $original"
            bash-usage "$0"
            exit 1;;
    esac
done

## Any args are color schemes.
for scheme in "$@"
do
    var="FOREBACKMAP_${scheme^^}"
    [ -n "${!var}" ] && schemes+=("${!var}") && shift
done

[ -z "${schemes[0]}" ] && var="FOREBACKMAP_$(xterm-cli background)" && schemes=("${!var}")

## Yeah this is a little funky - you could end up creating "count"
## terminals of each color scheme.
declare i=0
declare j=$i
declare delta_x=36
declare delta_y=36
xtg ()
{
    echo "${lxtermgeo_w}x${XTERMGEO_H}+$((XTERMGEO_X+(j*delta_x)))+$((XTERMGEO_Y+(j*delta_y)))"
}

while ((i<count))
do
    for scheme in "${schemes[@]}"
    do
        declare -a cmd=(RXCmd "$HOSTNAME" -geometry "$(xtg)" "$XTERMFONTS" "$@" -fg "${scheme%%,*}" -bg "${scheme##*,}")
        # shellcheck disable=SC2086 # $XTERMFONTS needs expansion
        case $proc_handling in
            da ) exec "${cmd[@]}" ;;
            bg ) "${cmd[@]}" &
                 sleep .05 ## Just enough to space out the &-ed invocations so
                           ## that they do not randomly appear, but rather
                           ## appear in a nice cascade.
                 ;;
            * ) "${cmd[@]}" ;;
            esac
        ((j+=1))
    done
    ((i+=1))
done
## POD guard
exit 0

## You can add sections with =head1, but stick to =item for section breakdowns,
## not =head2/3/etc/.

:<<'__PODUSAGE__'
=head1 NAME

newx - create a new xterm

=head1 SYNOPSIS

 newx [-w|-n|-s] [-n_terms] [scheme [scheme ...]]

=head1 DESCRIPTION

Creates a new xterm.

=head1 OPTIONS

=over 4

=item scheme

Create a new xterm in the color scheme specified. Schemes can be determined by
running this command with the --schemes option. Without a scheme argument, the
new xterm is the same as the xterm from which the command was executed or, if
that cannot be determined, the default scheme 'wheat'.

=back

=head1 OPTIONS

=over 4

=item -w|-n|-s

Create a wide, narrow or standard width xterm. Default is standard (132). Wide
and narrow are twice and half that, respectively.

=item -n_terms

Opens 'n_terms' number of terms, where 'n_terms' > 0. Default is 1.

=item -scheme

List the available color schemes.

=back

=cut

__PODUSAGE__
