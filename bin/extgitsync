## -*- sh -*-

repo=$1

[ -z "$repo" ] && echo "Need a repo name with a master branch to tack onto ~/gits/bbgithub/mpersico5/ " && exit 1
source_git=~/gits/bbgithub/mpersico5/$repo

[ ! -d $source_git ] && echo Cannot find source git $source_git && exit 1
target_git=~/gits/github/matthewpersico/$repo/wt/bloomberg

[ ! -d $target_git ] && echo Cannot find target git $target_git && exit 1
target_patches_inbound=./patches_dir.from.$(hostname):.home.mpersico5.gits.bbgithub.mpersico5.personal

if [ ! "$1" = '--post-patch' ]
then
    ## Check the target for cleanliness
    cd $target_git
    [ ! -d $target_patches_inbound ] && mkdir $target_patches_inbound
    restarts=$(ls -lart $target_patches_inbound/restore*restart* 2>/dev/null)
    if [ -n "$restarts" ]
    then
        echo "Restarts exist. You cleanup. I'm bailing"
        exit 1
    fi

    ## Make patches
    cd $source_git
    git pull
    git-create-patches
    if (($?))
    then
        echo "If no patches were created, did you merge latest updates into master?"
        exit ## no patches or an error
    fi

    ## CUT N PASTED from git-create-patches
    sharfile=$(git-root)/$(basename $(git-root)).shar

    ## Copy patches to target and expand
    mv ${sharfile}* $target_git
    cd $target_git
    rm -f $target_patches_inbound/restore*
    unshar -d $target_patches_inbound $(basename ${sharfile})*

    ## Apply patches
    cd $target_patches_inbound
    ./$(ls restore.*)
    if (($?))
    then
        echo "Once you fix the problem, run $0 --post-patch"
        exit ## Error
    fi
fi

## Make patches for external
cd $target_git
gcpout=git-create-patches.out.$(date +%Y%m%d_%H%M%S)
git-create-patches --no-shar 2>&1 | tee $gcpout
ls -lart patches_dir.outbound
echo "Now figure out which *.patch and restore.* files in"
echo "$target_git/patches_dir.outbound' need to be moved to Cygwin."
echo "Use $target_git/$gcpout to help figure that out."
