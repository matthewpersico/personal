#! /usr/bin/env perl

use strict;
use warnings;

use Getopt::Long;
use POSIX qw(strftime);

my %opts;

GetOptions(
    \%opts, qw(i
      include-dir
      )
);
my $pattern = shift;
$pattern = "(?i)$pattern" if $opts{i};
$pattern = qr/$pattern/;
my $time;
my $dir;
my @entries;
for my $file (@ARGV) {
    my $ih = IO::File->new("< $file")
      or die "Cannot open $file:$!";
    while (<$ih>) {
        $_ =~ m/^##/ && pop @entries && next;
        chomp;
        $_ =~ m/^#(\d+)/ && do {
            push @entries, [$1];
            if (    $opts{'include-dir'}
                and $_ =~ m/## pwd => (.*)/ )
            {
                $entries[-1]->[2] = $1;
            }
            next;
        };
        if ( $_ =~ m/$pattern/ ) {
            $entries[-1]->[1] = $_;
        } else {
            pop @entries;
        }
    }
}

@entries = sort { $a->[0] <=> $b->[0] } @entries;
$ENV{HISTTIMEFORMAT} ||= '%m/%d - %H:%M:%S';
my $datelen = 0;
for (@entries) {
    $datelen = length( strftime( $ENV{HISTTIMEFORMAT}, localtime(1) ) )
      if not $datelen;
    printf( "%s %s%s\n",
        strftime( $ENV{HISTTIMEFORMAT}, localtime( $_->[0] ) ),
        $_->[1], ( $_->[2] ? "\n" . ' ' x $datelen . "($_->[2])" : '' ) );
}
