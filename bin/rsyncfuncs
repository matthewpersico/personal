# -*- sh -*-

# rsyncfuncs

RSYNCFUNCS_FILE=${BASH_SOURCE[0]}

rsyncfuncs_ls ()
{
    ls -l $RSYNCFUNCS_FILE
}
#nxport -f rsyncfuncs_ls
alias rsyncfuncs-dir=rsyncfuncs_ls

rsyncfuncs_edit ()
{
    xo $RSYNCFUNCS_FILE
}
#nxport -f rsyncfuncs_edit
alias rsyncfuncs-edit=rsyncfuncs_edit

rsyncfuncs_reload ()
{
    . $RSYNCFUNCS_FILE
}
#nxport -f rsyncfuncs_reload
alias rsyncfuncs-reload=rsyncfuncs_reload
alias rsyncfuncs-load=rsyncfuncs_reload

_rsync2nfs_usage ()
{
    echo "Usage: rsync2nfs -t|--target tgt \ "
    echo "                 [--verbose|-v] \ "
    echo "                 [ [--timestamp|-t] | [--multistamp|-m] ]\ "
    echo "                 src [src...]"
    echo "       rsync2nfs --help|-h"
    echo
}
#nxport -f _rsync2nfs_usage

RSYNCFUNCS_LOG_HOME="${HOME}/rsync2fs"
export RSYNCFUNCS_LOG_HOME

rsync2nfs ()
{
    local target
    local verbose
    local timestamp
    local multistamp
    local excludeFrom
    local OPTSARGS=$(getoptp -o t:vh --long target:,verbose,timestamp,multistamp,help,excludeFrom: -- "$@")
    status=$?
    ((status != 0)) && _rsync2nfs_usage && return $status

    eval set -- "$OPTSARGS"
    while true
    do
        case "$1" in
            -h|--help) _rsync2nfs_usage; return 0 ;;
            -t|--target) shift; target=$1; shift ;;
            -v|--verbose) verbose='-v'; shift ;;
            --timestamp) timestamp=1; shift;;
            --multistamp) timestamp=1; multistamp=1; shift;;
            --excludeFrom) excludeFrom="--exclude-from=$2"; shift; shift;;
            --) shift; break ;; ## end of opts, remaining $*, if any, are args
            *) echo "Internal error!"; _rsync2nfs_usage; return 1 ;;
        esac
    done

    if [ -z "$target" ]
    then
        echo "--target required";
        _rsync2nfs_usage;
        exit 1;
    fi

    [ -z "$multistamp" ] && /bin/rm -f $RSYNCFUNCS_LOG_HOME/rsync2fs.timestamp.*
    if [ -n "$timestamp" ]
    then
        mkdir -p $RSYNCFUNCS_LOG_HOME
        timestamp="$RSYNCFUNCS_LOG_HOME/rsync2fs.timestamp.$(date +%Y-%m-%dT%H-%M-%S)"

        ## Purge - we don't need more than 4 days (YES +3 GIVES US 4 DAYS)
        find $RSYNCFUNCS_LOG_HOME -type f -mtime +3 -delete

        ## STDOUT to the log
        exec 1> $timestamp

        ## STDERR to the log AND STDERR (so that cron reading STDERR will send an email)
        exec 2> >(tee -ia $timestamp >&2)
    fi

    if [ -n "$verbose" ]
    then
        echo "** Command: rsync -a -z -r -l $verbose $excludeFrom --delete $@ $target"
        echo "** Log: $timestamp"
        echo "** Start: $(date)"
        local start=$(date +%s)
    fi
    ## -a "archive" mode, which ensures that symbolic links, devices,
    ## -attributes, permissions, ownerships, etc. are preserved in the
    ## -transfer.
    ## -z - transport compressed
    ## -r - recurse
    ## -l - copy symlinks as symlinks
    ## $verbose: -v - verbose
    ## $excludeFrom --excludeFrom=a file with exclusions not to sync
    ## --delete - if it was deleted in the source, delete it in the target too.
    ## -i - ssh stuff
    local sshfile
    for i in "${HOME}/.ssh/$(hostname)" "${HOME}/.ssh/id_rsa.$(hostname)"
    do
        [ -e $i ] && sshfile=$i
    done
    if [ -z "$sshfile" ]
    then
        echo "!! Cannot rsync - no ssh identity file found"
        return 1
    fi
    local sshtext="ssh -i $sshfile"
    rsync -e "$sshtext" -a -z -r -l $verbose  $excludeFrom --delete "$@" $target &
    local rsyncpid=$!
    if [ -n "$verbose" ]
    then
        echo "** Command PID: $rsyncpid"
    fi
    wait $rsyncpid
    status=$?
    if [ -n "$verbose" ]
    then
        echo "** End: $(date)"
        local end=$(date +%s)
        echo "** Elapsed: $(( (end-start)/60 )) minutes, $(( (end-start)%60 )) seconds"
    fi
    return $status
}
#nxport -f rsync2nfs

NFSMACHINE=nylxdev1.dev.bloomberg.com
rsyncvmgits ()
{
    rsync2nfs -v --timestamp --target $NFSMACHINE:vmstashes/$(hostname)/mpersico5 ~/gits
    return $?
}
#nxport -f rsyncvmgits

rsyncvm-running()
{
    local silent=0
    if [ "$1" = '-s' ]
    then
        silent=1
    fi

    local target="$NFSMACHINE:vmstashes/$(hostname)"
    local running=$(mktemp --suffix=.rsyncvm-running)
    local ret
    ps lxf | grep -E "COMMAND|rsync.*$target" | grep -v grep  > $running
    if [ "$(cat $running | wc -l)" != 1 ]
    then
        cat $running
        ret=1
    else
        ((silent)) || echo "Not running"
        ret=0
    fi
    \rm -f $running
    return $ret
}

_rsyncvm_usage ()
{
    echo "Usage: rsyncvm [--verbose|-v] [--help|-h] [--excludeFrom=FileOfExcludes]"
    echo
}

rsyncvm ()
{
    local verbose=''
    local silent='-s'
    local excludeFrom=''
    local OPTSARGS=$(getoptp -o vh --long verbose,help,excludeFrom: -- "$@")
    status=$?
    ((status != 0)) && _rsyncvm_usage && return $status

    eval set -- "$OPTSARGS"
    while true
    do
        case "$1" in
            -h|--help)
                _rsyncvm_usage; return 0 ;;
            -v|--verbose)
                verbose='-v'; silent=''; shift ;;
            --excludeFrom)
                excludeFrom="$2"; shift; shift
                if [ -r $excludeFrom ]
                then
                    local exclusions=$(grep -v '#' $excludeFrom);
                    if [ -n "$exclusions" ]
                    then
                        excludeFrom="--exclude-from=$excludeFrom"
                        if [ ! "$exclusions" = 'nosync' ]
                        then
                            echo "This rsyncvm is run with the following exclusions:"
                            cat $excludeFrom
                        fi
                    fi
                fi
                ;;
            --) shift; break ;; ## end of opts, remaining $*, if any, are args
            *) echo "Internal error!"; _rsyncvm_usage; return 1 ;;
        esac
    done

    local status
    local target="$NFSMACHINE:vmstashes/$(hostname)"
    rsyncvm-running -s > /tmp/rsyncvm.$$.runningcheck
    status=$?
    if [ "$status" = '0' ]
    then
        rsync2nfs $verbose $excludeFrom --multistamp --target $target ~
        status=$?
    else
        echo "Another rsyncvm appears to be running--^. See:"
        local rsyncpid=$(cat /tmp/rsyncvm.$$.runningcheck | tail -1 | cols -keep 2)
        local log=$(grep -l "Command PID: $rsyncpid" $RSYNCFUNCS_LOG_HOME/* | sort -r | head -1)
        if [ -n "$log" ]
        then
            cat $log
        fi
        status=1
    fi
    return $status
}
#nxport -f rsyncvm
alias vmsync='rsyncvm '

rsyncvm-status ()
{
    date
    touch /tmp/now.rsyncvm-status
    ls -lart $RSYNCFUNCS_LOG_HOME/rsync2fs.timestamp.* /tmp/now.rsyncvm-status
    ssh $NFSMACHINE 'ls -la ~/.snapshot'
    rsyncvm-running | tee /tmp/rsyncvm-status.$$.runningcheck
    if [ ! "$(grep 'Not running' /tmp/rsyncvm-status.$$.runningcheck)" = 'Not running' ]
    then
        local rsyncpid=$(cat /tmp/rsyncvm-status.$$.runningcheck | tail -1 | cols -keep 2)
        local log=$(grep -l "Command PID: $rsyncpid" $RSYNCFUNCS_LOG_HOME/* | sort -r | head -1)
        if [ -n "$log" ]
        then
            tail -n +1 -f $log
        fi
        status=1
    fi
}

rsyncvm-pause ()
{
    touch /tmp/pause.rsyncvm.cron
    ls -lart /tmp/pause.rsyncvm.cron
}

rsyncvm-resume ()
{
    ls -lart /tmp/pause.rsyncvm.cron
    rm /tmp/pause.rsyncvm.cron
    ls -lart /tmp/pause.rsyncvm.cron
}
