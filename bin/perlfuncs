# -*- sh -*-

# perlfuncs

auditfuncs-init
. $(which controlfuncs_build)

addpath -x -f -p PERL5LIB ~/personal/share/perl5/site_perl/5.16


perl-current-version()
{
    ## Prints Maj.Min. If $1 == --full, prints Maj.Min.Patch
    perl -MConfig -MData::Dumper -e '$x=$Config{version};$x=~s/(\.[0-9]+$)//;print $x'-- $1
}

perl-add-local()
{

    perl-add-root ~/perl
}

perl-add-root ()
{
    local roottoadd=$1
    [ -z "$roottoadd" ] && roottoadd=${HOME}/perl
    roottoadd=$(realpath $roottoadd)

    ## Clean first in case they exist in the wrong order
    perl-del-root $roottoadd

    local pcv=$(perl-current-version)
    ## Remember, these are in reverse order of how they need to appear
    addpath -x -f -p PERL5LIB $roottoadd/share/perl5
    addpath -x -f -p PERL5LIB $roottoadd/share/perl5/site_perl
    addpath -x -f -p PERL5LIB $roottoadd/share/perl5/site_perl/$pcv
    addpath -x -f -p PERL5LIB $roottoadd/lib/perl5
    addpath -x -f -p PERL5LIB $roottoadd/lib/perl5/site_perl
    addpath -x -f -p PERL5LIB $roottoadd/lib/perl5/site_perl/$pcv
    addpath -x -f -p PATH $roottoadd/bin
    addpath -x -f -p MANPATH $roottoadd/man

    perl-list-root ~roottoadd
}

perl-list-local()
{
    perl-list-root ~/perl
}

perl-list-root()
{
    local roottolist=$1
    [ -z "$roottolist" ] && roottolist=${HOME}/perl
    roottolist=$(realpath $roottolist)
    listpath -p PERL5LIB | grep $roottolist
    listpath -p PATH | grep $roottolist/bin
    listpath -p MANPATH | grep $roottolist/man
}

perl-del-local()
{
    perl-del-root ~/perl
}

perl-del-root()
{
    local roottodel=$1
    [ -z "$roottodel" ] && roottodel=${HOME}/perl
    roottodel=$(realpath $roottodel)

    local pcv=$(perl-current-version)
    delpath -x -c -p PERL5LIB $roottodel/share/perl5
    delpath -x -c -p PERL5LIB $roottodel/share/perl5/site_perl
    delpath -x -c -p PERL5LIB $roottodel/share/perl5/site_perl/$pcv
    delpath -x -c -p PERL5LIB $roottodel/lib/perl5
    delpath -x -c -p PERL5LIB $roottodel/lib/perl5/site_perl
    delpath -x -c -p PERL5LIB $roottodel/lib/perl5/site_perl/$pcv
    delpath -x -c -p PATH $roottodel/bin
    delpath -x -c -p MANPATH $roottodel/man
}

perl-filter-code ()
{
    local file
    for file in $*
    do
        head -1 $file | grep perl | grep -E '^#!' > /dev/null
        if [ "$?" == '0' ]
        then
            foundperl="$foundperl $i"
        else
            echo $file | grep -iE '\.(p[ml]|t|sgi)$' > /dev/null
            if [ "$?" == '0' ]
            then
                foundperl="$foundperl $i"
            fi
        fi
    done
    echo $foundperl
    local words=($foundperl)
    return ${#words[@]}
}

perl-find-code ()
{
    perl-filter-code $(find "$@")
    return $?
}

safe_func_export --this

auditfuncs-end
