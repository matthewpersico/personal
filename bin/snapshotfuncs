# -*- sh -*-

# snapshot_funcs

SNAPSHOTFUNCS_FILE=${BASH_SOURCE[0]}

snapshotfuncs_edit ()
{
    xo $SNAPSHOTFUNCS_FILE
}
export -f snapshotfuncs_edit
alias snapshotfuncs-edit=snapshotfuncs_edit

snapshotfuncs_reload ()
{
    . $SNAPSHOTFUNCS_FILE
}
export -f snapshotfuncs_reload
alias snapshotfuncs-reload=snapshotfuncs_reload

snapshot_go ()
{
    local tgtspec=$(pwd)
    tgtspec=${tgtspec#$HOME}
    tgtspec=${tgtspec#/}

    local snapmirrors=$(ls -c1 ~/.snapshot | sort | grep -v snap)
    select snapmirror in $snapmirrors
    do
        if [ -n "$snapmirror" ]
        then
            cd ${HOME}/.snapshot/${snapmirror}/$tgtspec
            break;
        fi
    done
}
export -f snapshot_go
alias snapshot-go='snapshot_go '

snapshot_diff ()
{
    local tgt=$1
    shift
    local tgtdir=$(builtin cd $(dirname $tgt);pwd)
    local tgtspec=$tgtdir/$(basename $tgt)
    tgtspec=${tgtspec#$HOME}
    tgtspec=${tgtspec#/}

    local snapmirrors=$(ls -c1 ~/.snapshot | sort | grep -v snap)
    select snapmirror in $snapmirrors "'q' to quit"
    do
        if [ "$REPLY" = 'q' ]
        then
            return
        fi

        if [ -n "$snapmirror" ]
        then
            diff -s $* ${HOME}/.snapshot/${snapmirror}/$tgtspec ${HOME}/$tgtspec
        fi
    done
}
export -f snapshot_diff
alias snapshot-diff='snapshot_diff '

snapshot_restore ()
{
    local tgt=$1
    shift
    if [ -z "$tgt" ]
    then
        echo "usage: snapshot_restore filepath"
        echo "       where 'filepath' is a complete"
        echo "       path to the file to restore OR"
        echo "       a file in the current directory"
        return 1
    fi
    local tgtdir=$(builtin cd $(dirname $tgt);pwd)
    local tgtfile=$(basename $tgt)
    local tgtspec=$tgtdir/$(basename $tgt)
    tgtspec=${tgtspec#$HOME}
    tgtspec=${tgtspec#/}

    local snapmirrors=$(ls -c1 ~/.snapshot | sort | grep -v snap)
    local PS3='Pick a snapshot dir: '
    select snapmirror in $snapmirrors
    do
        if [ -n "$snapmirror" ]
        then
            local mirrorfile=${HOME}/.snapshot/${snapmirror}/$tgtspec
                 local tgtfile=${HOME}/$tgtspec
            local lsfiles
            local difffiles
            local catfiles

            if [ ! -e $mirrorfile ]
            then
                echo "No $tgtspec found in this snapshot"
            else
                lsfiles="$lsfiles $mirrorfile"
                difffiles="$difffiles $mirrorfile"
            fi

            if [ ! -e $tgtspec ]
            then
                echo "$tgtspec is gone."
                catfiles="$catfiles $mirrorfile"
            else
                lsfiles="$lsfiles $tgtspec"
                difffiles="$difffiles $tgtspec"
            fi

            ls -la $lsfiles
            resp=$(yesno "Continue" n)
            if [ "$resp" == 'y' ]
            then
                if [ -n "$catfiles" ]
                then
                    cat $catfiles
                else
                    diff -s $* $difffiles
                fi
                resp=$(yesno "Restore from snapshot" n)
                if [ "$resp" == 'y' ]
                then
                    cp -v ${HOME}/.snapshot/${snapmirror}/$tgtspec ${HOME}/$tgtspec
                    break
                fi
            fi
        fi
    done
}
export -f snapshot_restore
alias snapshot-restore='snapshot_restore '
